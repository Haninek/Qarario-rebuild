{% extends "layout.html" %}
{% block title %}Admin Dashboard{% endblock %}
{% block content %}
<h2 class="mb-4">üîê Admin Control Panel</h2>

<div class="row g-4">
  <div class="col-md-4">
    <div class="card h-100 shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Form Editor</h5>
        <p class="card-text">Edit the finance scoring questions in real time.</p>
        <a href="/builder" class="btn btn-primary w-100">Edit Questionnaire</a>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card h-100 shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Latest Logs</h5>
        <p class="card-text">Review recent scoring decisions and inputs.</p>
        <a href="/insights/" class="btn btn-outline-secondary w-100">View Insights</a>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card h-100 shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Test Engine</h5>
        <p class="card-text">Manually trigger scoring with test JSON input.</p>
        <a href="/score/" class="btn btn-outline-dark w-100">Run a Test</a>
      </div>
    </div>
  </div>
</div>

<hr class="my-5" />

<h4 class="mb-3">üë• User Management</h4>
<div class="card mb-4">
  <div class="card-body">
    <div class="d-flex justify-content-end mb-3">
      <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addUserModal">
        Add User
      </button>
    </div>
    <div id="usersList">
      <div class="text-center">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
    </div>
  </div>
</div>

<h4 class="mb-3">üìÑ Recent Logs (last 10 entries)</h4>
<div class="table-responsive">
  <table class="table table-striped table-bordered">
    <thead>
      <tr>
        <th scope="col">Timestamp</th>
        <th scope="col">Score</th>
        <th scope="col">Offers</th>
      </tr>
    </thead>
    <tbody>
      {% for entry in logs %}
      <tr>
        <td>{{ entry.timestamp }}</td>
        <td>{{ entry.score.total_score }}</td>
        <td>
          {% for o in entry.offers %}
            <span class="badge bg-success">${{ o }}</span>
          {% endfor %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add New User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addUserForm">
          <div class="mb-3">
            <label class="form-label">User ID</label>
            <input type="text" class="form-control" id="userId" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Username</label>
            <input type="text" class="form-control" id="username" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" id="email" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Subscription Tier</label>
            <select class="form-select" id="subscriptionTier">
              <option value="free">Free</option>
              <option value="premium">Premium</option>
              <option value="enterprise">Enterprise</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="addUser()">Add User</button>
      </div>
    </div>
  </div>
</div>

<script>
// Load users on page load
document.addEventListener('DOMContentLoaded', function() {
    loadUsers();
});

async function loadUsers() {
    try {
        const response = await fetch('/admin/users');
        const users = await response.json();

        const usersList = document.getElementById('usersList');
        if (users.length === 0) {
            usersList.innerHTML = '<p class="text-muted">No users found.</p>';
            return;
        }

        let html = '<div class="table-responsive"><table class="table table-striped">';
        html += '<thead><tr><th>User ID</th><th>Username</th><th>Email</th><th>Subscription</th><th>API Access</th><th>Created</th><th>Actions</th></tr></thead><tbody>';

        users.forEach(user => {
            html += `<tr>
                <td>${user.user_id}</td>
                <td>${user.username}</td>
                <td>${user.email || 'N/A'}</td>
                <td><span class="badge bg-${user.subscription_tier === 'enterprise' ? 'success' : user.subscription_tier === 'premium' ? 'warning' : 'secondary'}">${user.subscription_tier}</span></td>
                <td><span class="badge bg-${user.api_access_enabled ? 'success' : 'danger'}">${user.api_access_enabled ? 'Enabled' : 'Disabled'}</span></td>
                <td>${new Date(user.created_at).toLocaleDateString()}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="editUser('${user.user_id}')">Edit</button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${user.user_id}')">Delete</button>
                </td>
            </tr>`;
        });

        html += '</tbody></table></div>';
        usersList.innerHTML = html;

    } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('usersList').innerHTML = '<p class="text-danger">Error loading users.</p>';
    }
}

async function addUser() {
    const userId = document.getElementById('userId').value;
    const username = document.getElementById('username').value;
    const email = document.getElementById('email').value;
    const subscriptionTier = document.getElementById('subscriptionTier').value;

    if (!userId || !username || !email) {
        alert('Please fill in all required fields.');
        return;
    }

    try {
        const response = await fetch('/admin/users', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_id: userId,
                username: username,
                email: email,
                subscription_tier: subscriptionTier
            })
        });

        if (response.ok) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addUserModal'));
            modal.hide();

            // Clear form
            document.getElementById('addUserForm').reset();

            // Reload users
            loadUsers();

            alert('User added successfully!');
        } else {
            const error = await response.json();
            alert('Error: ' + error.error);
        }
    } catch (error) {
        console.error('Error adding user:', error);
        alert('Error adding user.');
    }
}

async function deleteUser(userId) {
    if (!confirm(`Are you sure you want to delete user ${userId}?`)) {
        return;
    }

    try {
        const response = await fetch(`/admin/users/${userId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            loadUsers();
            alert('User deleted successfully!');
        } else {
            const error = await response.json();
            alert('Error: ' + error.error);
        }
    } catch (error) {
        console.error('Error deleting user:', error);
        alert('Error deleting user.');
    }
}

function editUser(userId) {
    // For now, just redirect to user management
    window.open(`/user/?user_id=${userId}`, '_blank');
}
</script>
{% endblock %}