
{% extends "layout.html" %}
{% block title %}Risk Assessment Builder{% endblock %}
{% block content %}
<div class="animated-bg"></div>
<div class="container-fluid builder-container">
    <div class="row">
        <div class="col-12">
            <div class="builder-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2 class="mb-1">ðŸŽ¯ Risk Assessment Builder</h2>
                        <p class="text-muted mb-0">Dynamically manage risk assessment questions and scoring algorithms</p>
                    </div>
                    <div>
                        <button class="btn btn-info me-2" onclick="testScoring()">
                            <i class="fas fa-calculator"></i> Test Scoring
                        </button>
                        <button class="btn btn-warning me-2" onclick="showAISuggestions()">
                            <i class="fas fa-magic"></i> AI Suggestions
                        </button>
                        <button class="btn btn-success me-2" onclick="addNewSection()">
                            <i class="fas fa-plus"></i> Add Section
                        </button>
                        <button class="btn btn-primary" onclick="saveChanges()">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Debug Information -->
            <div class="alert alert-info" id="debugInfo">
                <strong>Debug:</strong> <span id="debugText">Loading...</span>
            </div>
            
            <!-- Enhanced Risk Assessment Overview -->
            <div class="builder-stats">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="card stats-card text-white">
                            <div class="card-body text-center py-4">
                                <i class="fas fa-layer-group fa-2x mb-3 opacity-75"></i>
                                <h2 id="totalSections" class="fw-bold mb-2">0</h2>
                                <p class="mb-0 opacity-90">Total Sections</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card stats-card text-white">
                            <div class="card-body text-center py-4">
                                <i class="fas fa-question-circle fa-2x mb-3 opacity-75"></i>
                                <h2 id="totalQuestions" class="fw-bold mb-2">0</h2>
                                <p class="mb-0 opacity-90">Total Questions</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card stats-card text-white">
                            <div class="card-body text-center py-4">
                                <i class="fas fa-weight-hanging fa-2x mb-3 opacity-75"></i>
                                <h2 id="totalWeight" class="fw-bold mb-2">0</h2>
                                <p class="mb-0 opacity-90">Total Weight Points</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="sections-container">
                <!-- Sections will be dynamically loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Question Modal -->
<div class="modal fade" id="questionModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="questionModalTitle">Add Risk Assessment Question</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="questionForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Question Text</label>
                                <input type="text" class="form-control" id="questionText" required>
                                <div class="form-text">Clear, specific question for risk assessment</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Field Key</label>
                                <input type="text" class="form-control" id="fieldKey" required>
                                <div class="form-text">Unique identifier (e.g., owner1_credit_score)</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Risk Weight (1-20)</label>
                                <input type="number" class="form-control" id="questionWeight" min="1" max="20" required>
                                <div class="form-text">Higher weight = more impact on risk score</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Data Type</label>
                                <select class="form-select" id="questionType" onchange="updateRiskSettings()">
                                    <option value="text">Text Input</option>
                                    <option value="number">Numeric Value</option>
                                    <option value="percentage">Percentage (0-100%)</option>
                                    <option value="currency">Currency Amount</option>
                                    <option value="select">Multiple Choice</option>
                                    <option value="boolean">Yes/No</option>
                                    <option value="date">Date</option>
                                </select>
                            </div>
                            <div class="mb-3" id="optionsContainer" style="display: none;">
                                <label class="form-label">Options</label>
                                <div id="optionsList">
                                    <!-- Dynamic options will be added here -->
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addOption()">
                                    <i class="fas fa-plus"></i> Add Option
                                </button>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="editingSectionKey">
                    <input type="hidden" id="editingFieldKey">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveQuestion()">Save Question</button>
            </div>
        </div>
    </div>
</div>

<style>
/* Enhanced Builder Styling */
.builder-container {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding-top: 2rem;
}

.builder-header {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
}

.builder-stats {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.stats-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none !important;
    border-radius: 15px;
    transform: translateY(0);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.stats-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
}

.section-card {
    border: none;
    border-radius: 20px;
    margin-bottom: 2rem;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    overflow: hidden;
}

.section-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
}

.section-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem 2rem;
    border-radius: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    overflow: hidden;
}

.section-header h4 {
    font-weight: 700;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    margin: 0;
}

.question-item {
    border: 2px solid #e9ecef;
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    transition: all 0.3s ease;
    position: relative;
}

.question-item:hover {
    background: linear-gradient(135deg, #ffffff 0%, #f0f4ff 100%);
    border-color: #667eea;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
}

.question-item h6 {
    color: #2d3748;
    font-weight: 600;
    font-size: 1.1rem;
    margin-bottom: 0.75rem;
}

.weight-badge {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 25px;
    font-size: 0.9rem;
    font-weight: 600;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.btn-action {
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
    border-radius: 10px;
    transition: all 0.3s ease;
    border: none;
    font-weight: 500;
}

.btn-action:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
}

.animated-bg {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}
</style>

<script>
// Debug: Check if rules data is available
console.log('Raw rules from server:', {{ rules | tojsonfilter | safe }});

let questionsData = {{ rules | tojsonfilter | safe }};
let questionModal;

document.addEventListener('DOMContentLoaded', function() {
    console.log('=== BUILDER PAGE LOADED ===');
    console.log('questionsData type:', typeof questionsData);
    console.log('questionsData:', questionsData);
    console.log('questionsData keys:', Object.keys(questionsData || {}));
    
    // Update debug info
    updateDebugInfo();
    
    questionModal = new bootstrap.Modal(document.getElementById('questionModal'));
    
    // Always try to load sections
    loadSections();
    updateStats();
});

function updateDebugInfo() {
    const debugText = document.getElementById('debugText');
    if (!questionsData) {
        debugText.textContent = 'questionsData is null/undefined';
    } else if (typeof questionsData !== 'object') {
        debugText.textContent = `questionsData is ${typeof questionsData}, not object`;
    } else {
        const sectionCount = Object.keys(questionsData).length;
        let totalQuestions = 0;
        Object.values(questionsData).forEach(section => {
            if (section && typeof section === 'object') {
                totalQuestions += Object.keys(section).length;
            }
        });
        debugText.textContent = `Loaded ${sectionCount} sections with ${totalQuestions} total questions`;
    }
}

function updateStats() {
    let totalQuestions = 0;
    let totalWeight = 0;
    let totalSections = 0;

    if (questionsData && typeof questionsData === 'object') {
        Object.keys(questionsData).forEach(sectionKey => {
            const section = questionsData[sectionKey];
            if (section && typeof section === 'object') {
                totalSections++;
                Object.keys(section).forEach(questionKey => {
                    const question = section[questionKey];
                    if (question && typeof question === 'object') {
                        totalQuestions++;
                        totalWeight += question.weight || 0;
                    }
                });
            }
        });
    }

    document.getElementById('totalSections').textContent = totalSections;
    document.getElementById('totalQuestions').textContent = totalQuestions;
    document.getElementById('totalWeight').textContent = totalWeight;
}

function loadSections() {
    const container = document.getElementById('sections-container');
    container.innerHTML = '';

    console.log('=== LOADING SECTIONS ===');
    console.log('questionsData:', questionsData);
    
    if (!questionsData || typeof questionsData !== 'object') {
        console.log('No questionsData or invalid type');
        container.innerHTML = `
            <div class="section-card">
                <div class="alert alert-warning m-3">
                    <h5><i class="fas fa-exclamation-triangle"></i> No Questions Found</h5>
                    <p>No risk assessment questions are currently configured.</p>
                    <button class="btn btn-primary" onclick="addNewSection()">
                        <i class="fas fa-plus"></i> Add First Section
                    </button>
                </div>
            </div>
        `;
        return;
    }

    const sections = Object.keys(questionsData);
    console.log('Found sections:', sections);
    
    if (sections.length === 0) {
        container.innerHTML = `
            <div class="section-card">
                <div class="alert alert-info m-3">
                    <h5><i class="fas fa-info-circle"></i> No Sections Found</h5>
                    <p>No sections are currently configured.</p>
                    <button class="btn btn-primary" onclick="addNewSection()">
                        <i class="fas fa-plus"></i> Add First Section
                    </button>
                </div>
            </div>
        `;
        return;
    }

    let sectionsCreated = 0;
    sections.forEach(sectionKey => {
        const section = questionsData[sectionKey];
        console.log(`Processing section: ${sectionKey}`, section);
        
        if (section && typeof section === 'object') {
            const sectionElement = createSectionElement(sectionKey, section);
            if (sectionElement) {
                container.appendChild(sectionElement);
                sectionsCreated++;
                console.log(`Successfully created section: ${sectionKey}`);
            }
        }
    });
    
    console.log(`Total sections created: ${sectionsCreated}`);
}

function createSectionElement(sectionKey, sectionData) {
    console.log(`=== CREATING SECTION: ${sectionKey} ===`);
    console.log('Section data:', sectionData);
    
    const sectionDiv = document.createElement('div');
    sectionDiv.className = 'section-card';

    const sectionFields = Object.keys(sectionData || {});
    const sectionWeight = Object.values(sectionData || {}).reduce((sum, q) => sum + (q && q.weight ? q.weight : 0), 0);

    console.log(`Section ${sectionKey} has ${sectionFields.length} fields with total weight ${sectionWeight}`);

    let questionsHtml = '';
    
    if (sectionFields.length === 0) {
        questionsHtml = '<p class="text-muted text-center py-4">No questions in this section yet.</p>';
    } else {
        questionsHtml = sectionFields.map(fieldKey => {
            const question = sectionData[fieldKey];
            console.log(`Processing question ${fieldKey}:`, question);
            
            if (!question || typeof question !== 'object') {
                console.log(`Skipping invalid question ${fieldKey}`);
                return '';
            }
            
            const questionText = question.question || fieldKey.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            const weight = question.weight || 1;
            const options = question.options || null;
            const dataType = question.data_type || 'text';
            
            const optionsText = options && options.length > 0 ? `Options: ${options.join(', ')}` : 'Free input';
            
            return `
                <div class="question-item">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">${questionText}</h6>
                            <small class="text-muted d-block">Field: <code>${fieldKey}</code> | Type: ${dataType}</small>
                            <small class="text-info d-block">${optionsText}</small>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <span class="weight-badge">Weight: ${weight}</span>
                            <button class="btn btn-sm btn-outline-primary btn-action" onclick="editQuestion('${sectionKey}', '${fieldKey}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger btn-action" onclick="deleteQuestion('${sectionKey}', '${fieldKey}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }).filter(html => html !== '').join('');
    }

    sectionDiv.innerHTML = `
        <div class="section-header">
            <div>
                <h4 class="mb-0">${sectionKey}</h4>
                <small class="opacity-75">${sectionFields.length} questions â€¢ ${sectionWeight} total weight</small>
            </div>
            <div>
                <button class="btn btn-light btn-sm me-2" onclick="addQuestion('${sectionKey}')">
                    <i class="fas fa-plus"></i> Add Question
                </button>
                <button class="btn btn-outline-light btn-sm" onclick="deleteSection('${sectionKey}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        <div class="p-4">
            ${questionsHtml}
        </div>
    `;

    return sectionDiv;
}

function addNewSection() {
    const sectionName = prompt('Enter section name for risk assessment:');
    if (sectionName && !questionsData[sectionName]) {
        questionsData[sectionName] = {};
        loadSections();
        updateStats();
        updateDebugInfo();
    } else if (questionsData[sectionName]) {
        alert('Section already exists!');
    }
}

function deleteSection(sectionKey) {
    if (confirm(`Are you sure you want to delete the "${sectionKey}" section and all its questions?`)) {
        delete questionsData[sectionKey];
        loadSections();
        updateStats();
        updateDebugInfo();
    }
}

function addQuestion(sectionKey) {
    document.getElementById('questionModalTitle').textContent = 'Add Risk Assessment Question';
    document.getElementById('questionForm').reset();
    document.getElementById('editingSectionKey').value = sectionKey;
    document.getElementById('editingFieldKey').value = '';
    updateRiskSettings();
    questionModal.show();
}

function editQuestion(sectionKey, fieldKey) {
    const question = questionsData[sectionKey][fieldKey];

    document.getElementById('questionModalTitle').textContent = 'Edit Risk Assessment Question';
    document.getElementById('questionText').value = question.question;
    document.getElementById('fieldKey').value = fieldKey;
    document.getElementById('questionWeight').value = question.weight;
    document.getElementById('editingSectionKey').value = sectionKey;
    document.getElementById('editingFieldKey').value = fieldKey;

    if (question.options) {
        document.getElementById('questionType').value = 'select';
        loadOptionsForEdit(question.options);
    } else {
        document.getElementById('questionType').value = question.data_type || 'text';
    }

    updateRiskSettings();
    questionModal.show();
}

function updateRiskSettings() {
    const questionType = document.getElementById('questionType').value;
    const optionsContainer = document.getElementById('optionsContainer');

    optionsContainer.style.display = questionType === 'select' ? 'block' : 'none';

    if (questionType === 'select') {
        document.getElementById('optionsList').innerHTML = '';
        addOption();
    }
}

function addOption() {
    const optionsList = document.getElementById('optionsList');
    const optionDiv = document.createElement('div');
    optionDiv.className = 'mb-2';
    optionDiv.innerHTML = `
        <div class="d-flex gap-2">
            <input type="text" class="form-control form-control-sm" placeholder="Option text" name="optionText">
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.parentElement.parentElement.remove()">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    optionsList.appendChild(optionDiv);
}

function loadOptionsForEdit(options) {
    const optionsList = document.getElementById('optionsList');
    optionsList.innerHTML = '';

    options.forEach(option => {
        const optionDiv = document.createElement('div');
        optionDiv.className = 'mb-2';
        optionDiv.innerHTML = `
            <div class="d-flex gap-2">
                <input type="text" class="form-control form-control-sm" placeholder="Option text" name="optionText" value="${option}">
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.parentElement.parentElement.remove()">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        optionsList.appendChild(optionDiv);
    });
}

function deleteQuestion(sectionKey, fieldKey) {
    if (confirm(`Are you sure you want to delete this question?`)) {
        delete questionsData[sectionKey][fieldKey];
        loadSections();
        updateStats();
        updateDebugInfo();
    }
}

function saveQuestion() {
    const sectionKey = document.getElementById('editingSectionKey').value;
    const oldFieldKey = document.getElementById('editingFieldKey').value;
    const newFieldKey = document.getElementById('fieldKey').value;
    const questionText = document.getElementById('questionText').value;
    const weight = parseInt(document.getElementById('questionWeight').value);
    const questionType = document.getElementById('questionType').value;

    if (!questionText || !newFieldKey || !weight) {
        alert('Please fill in all required fields');
        return;
    }

    if (oldFieldKey !== newFieldKey && questionsData[sectionKey][newFieldKey]) {
        alert('A question with this field key already exists in this section!');
        return;
    }

    const questionData = {
        question: questionText,
        weight: weight,
        data_type: questionType
    };

    if (questionType === 'select') {
        const options = [];
        const optionTexts = document.querySelectorAll('input[name="optionText"]');
        optionTexts.forEach(input => {
            if (input.value.trim()) {
                options.push(input.value.trim());
            }
        });
        questionData.options = options;
    }

    // If editing and field key changed, delete old entry
    if (oldFieldKey && oldFieldKey !== newFieldKey) {
        delete questionsData[sectionKey][oldFieldKey];
    }

    questionsData[sectionKey][newFieldKey] = questionData;

    questionModal.hide();
    loadSections();
    updateStats();
    updateDebugInfo();
}

function testScoring() {
    alert('Test scoring functionality will be implemented in the next update.');
}

function showAISuggestions() {
    alert('AI suggestions functionality will be implemented in the next update.');
}

function saveChanges() {
    fetch('/builder/save', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'rules=' + encodeURIComponent(JSON.stringify(questionsData))
    })
    .then(response => {
        if (response.ok) {
            alert('Risk assessment configuration saved successfully!');
            window.location.reload();
        } else {
            alert('Error saving changes');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving changes');
    });
}
</script>
{% endblock %}
