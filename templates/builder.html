
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Risk Assessment Builder - Qarari</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .builder-container {
            padding: 2rem 0;
        }

        .builder-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 15px;
            color: white;
            transition: transform 0.3s ease;
        }

        .stats-card:hover {
            transform: translateY(-5px);
        }

        .section-card {
            background: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 20px;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .question-item {
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            transition: all 0.3s ease;
        }

        .question-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }

        .weight-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-weight: 600;
        }

        .btn-action {
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .btn-action:hover {
            transform: translateY(-2px);
        }

        .modal-content {
            border-radius: 20px;
        }

        .form-control, .form-select {
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="container builder-container">
        <!-- Header -->
        <div class="builder-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">ðŸŽ¯ Risk Assessment Builder</h2>
                    <p class="text-muted mb-0">Dynamically manage risk assessment questions and scoring algorithms</p>
                </div>
                <div>
                    <button class="btn btn-info me-2" onclick="testScoring()">
                        <i class="fas fa-calculator"></i> Test Scoring
                    </button>
                    <button class="btn btn-success me-2" onclick="addNewSection()">
                        <i class="fas fa-plus"></i> Add Section
                    </button>
                    <button class="btn btn-primary" onclick="saveChanges()">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card stats-card">
                    <div class="card-body text-center py-4">
                        <i class="fas fa-layer-group fa-2x mb-3 opacity-75"></i>
                        <h2 id="totalSections" class="fw-bold mb-2">0</h2>
                        <p class="mb-0 opacity-90">Total Sections</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stats-card">
                    <div class="card-body text-center py-4">
                        <i class="fas fa-question-circle fa-2x mb-3 opacity-75"></i>
                        <h2 id="totalQuestions" class="fw-bold mb-2">0</h2>
                        <p class="mb-0 opacity-90">Total Questions</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stats-card">
                    <div class="card-body text-center py-4">
                        <i class="fas fa-weight-hanging fa-2x mb-3 opacity-75"></i>
                        <h2 id="totalWeight" class="fw-bold mb-2">0</h2>
                        <p class="mb-0 opacity-90">Total Weight Points</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sections Container -->
        <div id="sectionsContainer">
            <!-- Sections will be loaded here -->
        </div>
    </div>

    <!-- Question Modal -->
    <div class="modal fade" id="questionModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="questionModalTitle">Add Risk Assessment Question</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="questionForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Question Text</label>
                                    <input type="text" class="form-control" id="questionText" required>
                                    <div class="form-text">Clear, specific question for risk assessment</div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Field Key</label>
                                    <input type="text" class="form-control" id="fieldKey" required>
                                    <div class="form-text">Unique identifier (e.g., owner1_credit_score)</div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Risk Weight (1-20)</label>
                                    <input type="number" class="form-control" id="questionWeight" min="1" max="20" required>
                                    <div class="form-text">Higher weight = more impact on risk score. Total system limit: 119 points.</div>
                                    <div id="weightStatus" class="form-text text-info"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Data Type</label>
                                    <select class="form-select" id="questionType" onchange="updateTypeSettings()">
                                        <option value="text">Text Input</option>
                                        <option value="number">Numeric Value</option>
                                        <option value="percentage">Percentage (0-100%)</option>
                                        <option value="currency">Currency Amount</option>
                                        <option value="select">Multiple Choice</option>
                                        <option value="boolean">Yes/No</option>
                                        <option value="date">Date</option>
                                    </select>
                                </div>
                                <div class="mb-3" id="optionsContainer" style="display: none;">
                                    <label class="form-label">Options</label>
                                    <div id="optionsList">
                                        <!-- Dynamic options will be added here -->
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addOption()">
                                        <i class="fas fa-plus"></i> Add Option
                                    </button>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="editingSectionKey">
                        <input type="hidden" id="editingFieldKey">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveQuestion()">Save Question</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let questionsData = {{ rules | tojsonfilter | safe }};
        let questionModal;

        console.log('Form Builder loaded with data:', questionsData);

        // Wait for Bootstrap to load before initializing
        window.addEventListener('load', function() {
            // Give a small delay to ensure Bootstrap is fully loaded
            setTimeout(function() {
                if (typeof bootstrap !== 'undefined') {
                    questionModal = new bootstrap.Modal(document.getElementById('questionModal'));
                    console.log('Bootstrap modal initialized successfully');
                } else {
                    console.error('Bootstrap is still not defined');
                }
                loadSections();
                updateStats();
            }, 100);
        });

        function loadSections() {
            const container = document.getElementById('sectionsContainer');
            container.innerHTML = '';

            if (!questionsData || Object.keys(questionsData).length === 0) {
                container.innerHTML = `
                    <div class="section-card">
                        <div class="alert alert-warning m-3">
                            <h5><i class="fas fa-exclamation-triangle"></i> No Questions Found</h5>
                            <p>No risk assessment questions are currently configured.</p>
                            <button class="btn btn-primary" onclick="addNewSection()">
                                <i class="fas fa-plus"></i> Add First Section
                            </button>
                        </div>
                    </div>
                `;
                return;
            }

            Object.keys(questionsData).forEach(sectionKey => {
                const section = questionsData[sectionKey];
                const sectionElement = createSectionElement(sectionKey, section);
                container.appendChild(sectionElement);
            });
        }

        function createSectionElement(sectionKey, sectionData) {
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'section-card';

            const sectionFields = Object.keys(sectionData || {});
            const sectionWeight = Object.values(sectionData || {}).reduce((sum, q) => sum + (q.weight || 0), 0);

            let questionsHtml = '';
            
            if (sectionFields.length === 0) {
                questionsHtml = '<div class="text-center py-4"><p class="text-muted">No questions in this section yet.</p></div>';
            } else {
                questionsHtml = sectionFields.map(fieldKey => {
                    const question = sectionData[fieldKey];
                    if (!question) return '';
                    
                    const questionText = question.question || fieldKey.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    const weight = question.weight || 1;
                    const dataType = question.data_type || 'text';
                    const options = question.options;
                    
                    const optionsText = options && options.length > 0 ? 
                        `Options: ${options.join(', ')}` : 
                        'Free input';
                    
                    return `
                        <div class="question-item">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">${questionText}</h6>
                                    <small class="text-muted d-block">Field: <code>${fieldKey}</code> | Type: ${dataType}</small>
                                    <small class="text-info d-block">${optionsText}</small>
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="weight-badge">Weight: ${weight}</span>
                                    <button class="btn btn-sm btn-outline-primary btn-action" onclick="editQuestion('${sectionKey}', '${fieldKey}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger btn-action" onclick="deleteQuestion('${sectionKey}', '${fieldKey}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).filter(html => html !== '').join('');
            }

            sectionDiv.innerHTML = `
                <div class="section-header">
                    <div>
                        <h4 class="mb-0">${sectionKey}</h4>
                        <small class="opacity-75">${sectionFields.length} questions â€¢ ${sectionWeight} total weight</small>
                    </div>
                    <div>
                        <button class="btn btn-light btn-sm me-2" onclick="addQuestion('${sectionKey}')">
                            <i class="fas fa-plus"></i> Add Question
                        </button>
                        <button class="btn btn-outline-light btn-sm" onclick="deleteSection('${sectionKey}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="p-4">
                    ${questionsHtml}
                </div>
            `;

            return sectionDiv;
        }

        function updateStats() {
            let totalQuestions = 0;
            let totalWeight = 0;
            let totalSections = 0;

            if (questionsData) {
                totalSections = Object.keys(questionsData).length;
                
                Object.values(questionsData).forEach(section => {
                    if (section) {
                        Object.values(section).forEach(question => {
                            if (question) {
                                totalQuestions++;
                                totalWeight += question.weight || 0;
                            }
                        });
                    }
                });
            }

            document.getElementById('totalSections').textContent = totalSections;
            document.getElementById('totalQuestions').textContent = totalQuestions;
            
            // Show weight with limit indicator
            const weightDisplay = `${totalWeight}/119`;
            document.getElementById('totalWeight').textContent = weightDisplay;
            
            // Color code the weight display based on usage
            const weightElement = document.getElementById('totalWeight').parentElement;
            if (totalWeight >= 119) {
                weightElement.className = 'card stats-card bg-danger';
            } else if (totalWeight >= 100) {
                weightElement.className = 'card stats-card bg-warning';
            } else {
                weightElement.className = 'card stats-card';
            }

            // Update weight status in modal if it's open
            updateWeightStatus();
        }

        function updateWeightStatus() {
            const weightStatusElement = document.getElementById('weightStatus');
            if (!weightStatusElement) return;

            let currentTotalWeight = 0;
            Object.values(questionsData).forEach(section => {
                if (section) {
                    Object.values(section).forEach(question => {
                        if (question && question.weight) {
                            currentTotalWeight += question.weight;
                        }
                    });
                }
            });

            // If editing, subtract the old weight
            const oldFieldKey = document.getElementById('editingFieldKey').value;
            const sectionKey = document.getElementById('editingSectionKey').value;
            if (oldFieldKey && questionsData[sectionKey] && questionsData[sectionKey][oldFieldKey]) {
                currentTotalWeight -= questionsData[sectionKey][oldFieldKey].weight || 0;
            }

            const remainingWeight = 119 - currentTotalWeight;
            weightStatusElement.textContent = `Current total: ${currentTotalWeight}/119. Available: ${remainingWeight} points.`;
            
            if (remainingWeight <= 0) {
                weightStatusElement.className = 'form-text text-danger';
                weightStatusElement.textContent = 'Weight limit reached! Cannot add more questions.';
            } else if (remainingWeight <= 10) {
                weightStatusElement.className = 'form-text text-warning';
            } else {
                weightStatusElement.className = 'form-text text-info';
            }
        }

        function addNewSection() {
            const sectionName = prompt('Enter section name for risk assessment:');
            if (sectionName && sectionName.trim()) {
                if (!questionsData[sectionName]) {
                    questionsData[sectionName] = {};
                    loadSections();
                    updateStats();
                } else {
                    alert('Section already exists!');
                }
            }
        }

        function deleteSection(sectionKey) {
            if (confirm(`Are you sure you want to delete the "${sectionKey}" section and all its questions?`)) {
                delete questionsData[sectionKey];
                loadSections();
                updateStats();
            }
        }

        function addQuestion(sectionKey) {
            document.getElementById('questionModalTitle').textContent = 'Add Risk Assessment Question';
            document.getElementById('questionForm').reset();
            document.getElementById('editingSectionKey').value = sectionKey;
            document.getElementById('editingFieldKey').value = '';
            updateTypeSettings();
            updateWeightStatus();
            
            if (questionModal) {
                questionModal.show();
            } else {
                console.error('Modal not initialized, trying to show modal directly');
                document.getElementById('questionModal').style.display = 'block';
                document.getElementById('questionModal').classList.add('show');
            }
        }

        function editQuestion(sectionKey, fieldKey) {
            const question = questionsData[sectionKey][fieldKey];

            document.getElementById('questionModalTitle').textContent = 'Edit Risk Assessment Question';
            document.getElementById('questionText').value = question.question || '';
            document.getElementById('fieldKey').value = fieldKey;
            document.getElementById('questionWeight').value = question.weight || 1;
            document.getElementById('editingSectionKey').value = sectionKey;
            document.getElementById('editingFieldKey').value = fieldKey;

            if (question.options) {
                document.getElementById('questionType').value = 'select';
                loadOptionsForEdit(question.options);
            } else {
                document.getElementById('questionType').value = question.data_type || 'text';
            }

            updateTypeSettings();
            updateWeightStatus();
            
            if (questionModal) {
                questionModal.show();
            } else {
                console.error('Modal not initialized, trying to show modal directly');
                document.getElementById('questionModal').style.display = 'block';
                document.getElementById('questionModal').classList.add('show');
            }
        }

        function updateTypeSettings() {
            const questionType = document.getElementById('questionType').value;
            const optionsContainer = document.getElementById('optionsContainer');

            optionsContainer.style.display = questionType === 'select' ? 'block' : 'none';

            if (questionType === 'select') {
                const optionsList = document.getElementById('optionsList');
                if (optionsList.children.length === 0) {
                    addOption();
                }
            }
        }

        function addOption() {
            const optionsList = document.getElementById('optionsList');
            const optionDiv = document.createElement('div');
            optionDiv.className = 'mb-2';
            optionDiv.innerHTML = `
                <div class="d-flex gap-2">
                    <input type="text" class="form-control form-control-sm" placeholder="Option text" name="optionText">
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            optionsList.appendChild(optionDiv);
        }

        function loadOptionsForEdit(options) {
            const optionsList = document.getElementById('optionsList');
            optionsList.innerHTML = '';

            options.forEach(option => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'mb-2';
                optionDiv.innerHTML = `
                    <div class="d-flex gap-2">
                        <input type="text" class="form-control form-control-sm" placeholder="Option text" name="optionText" value="${option}">
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.parentElement.parentElement.remove()">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                optionsList.appendChild(optionDiv);
            });
        }

        function deleteQuestion(sectionKey, fieldKey) {
            if (confirm(`Are you sure you want to delete this question?`)) {
                delete questionsData[sectionKey][fieldKey];
                loadSections();
                updateStats();
            }
        }

        function saveQuestion() {
            const sectionKey = document.getElementById('editingSectionKey').value;
            const oldFieldKey = document.getElementById('editingFieldKey').value;
            const newFieldKey = document.getElementById('fieldKey').value;
            const questionText = document.getElementById('questionText').value;
            const weight = parseInt(document.getElementById('questionWeight').value);
            const questionType = document.getElementById('questionType').value;

            if (!questionText || !newFieldKey || !weight) {
                alert('Please fill in all required fields');
                return;
            }

            if (oldFieldKey !== newFieldKey && questionsData[sectionKey][newFieldKey]) {
                alert('A question with this field key already exists in this section!');
                return;
            }

            // Check total weight limit (119 points maximum)
            let currentTotalWeight = 0;
            Object.values(questionsData).forEach(section => {
                if (section) {
                    Object.values(section).forEach(question => {
                        if (question && question.weight) {
                            currentTotalWeight += question.weight;
                        }
                    });
                }
            });

            // If editing, subtract the old weight first
            if (oldFieldKey && questionsData[sectionKey][oldFieldKey]) {
                currentTotalWeight -= questionsData[sectionKey][oldFieldKey].weight || 0;
            }

            // Check if adding this weight would exceed the limit
            if (currentTotalWeight + weight > 119) {
                const remainingWeight = 119 - currentTotalWeight;
                alert(`Cannot exceed total weight limit of 119 points! Current total: ${currentTotalWeight}. Maximum weight for this question: ${remainingWeight}`);
                return;
            }

            const questionData = {
                question: questionText,
                weight: weight,
                data_type: questionType
            };

            if (questionType === 'select') {
                const options = [];
                const optionTexts = document.querySelectorAll('input[name="optionText"]');
                optionTexts.forEach(input => {
                    if (input.value.trim()) {
                        options.push(input.value.trim());
                    }
                });
                if (options.length > 0) {
                    questionData.options = options;
                }
            }

            // If editing and field key changed, delete old entry
            if (oldFieldKey && oldFieldKey !== newFieldKey) {
                delete questionsData[sectionKey][oldFieldKey];
            }

            questionsData[sectionKey][newFieldKey] = questionData;

            if (questionModal) {
                questionModal.hide();
            } else {
                document.getElementById('questionModal').style.display = 'none';
                document.getElementById('questionModal').classList.remove('show');
            }
            loadSections();
            updateStats();
        }

        function testScoring() {
            alert('Test scoring functionality coming soon!');
        }

        function saveChanges() {
            fetch('/builder/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'rules=' + encodeURIComponent(JSON.stringify(questionsData))
            })
            .then(response => {
                if (response.ok) {
                    alert('Risk assessment configuration saved successfully!');
                    window.location.reload();
                } else {
                    return response.text().then(text => {
                        throw new Error(text);
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error saving changes: ' + error.message);
            });
        }
    </script>
</body>
</html>
