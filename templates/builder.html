
{% extends "layout.html" %}
{% block title %}Questionnaire Builder{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">ðŸ›  Questionnaire Builder</h2>
                    <p class="text-muted mb-0">Manage assessment questions and scoring weights</p>
                </div>
                <div>
                    <button class="btn btn-success me-2" onclick="addNewSection()">
                        <i class="fas fa-plus"></i> Add Section
                    </button>
                    <button class="btn btn-primary" onclick="saveChanges()">
                        <i class="fas fa-save"></i> Save All Changes
                    </button>
                </div>
            </div>

            <div id="sections-container">
                <!-- Sections will be dynamically loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Question Modal -->
<div class="modal fade" id="questionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="questionModalTitle">Add Question</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="questionForm">
                    <div class="mb-3">
                        <label class="form-label">Question Text</label>
                        <input type="text" class="form-control" id="questionText" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Field Key</label>
                        <input type="text" class="form-control" id="fieldKey" required>
                        <div class="form-text">Unique identifier for this field (e.g., owner1_credit_score)</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Weight (Score Points)</label>
                        <input type="number" class="form-control" id="questionWeight" min="1" max="20" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Question Type</label>
                        <select class="form-select" id="questionType" onchange="toggleOptions()">
                            <option value="text">Text Input</option>
                            <option value="number">Number Input</option>
                            <option value="select">Multiple Choice</option>
                            <option value="date">Date Input</option>
                        </select>
                    </div>
                    <div class="mb-3" id="optionsContainer" style="display: none;">
                        <label class="form-label">Options (one per line)</label>
                        <textarea class="form-control" id="questionOptions" rows="4" placeholder="Yes&#10;No&#10;Maybe"></textarea>
                    </div>
                    <input type="hidden" id="editingSectionKey">
                    <input type="hidden" id="editingFieldKey">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveQuestion()">Save Question</button>
            </div>
        </div>
    </div>
</div>

<style>
.section-card {
    border: 2px solid #e9ecef;
    border-radius: 12px;
    margin-bottom: 2rem;
    transition: all 0.3s ease;
}
.section-card:hover {
    border-color: #007bff;
    box-shadow: 0 4px 12px rgba(0,123,255,0.15);
}
.section-header {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 10px 10px 0 0;
    display: flex;
    justify-content: between;
    align-items: center;
}
.question-item {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.5rem;
    background: #f8f9fa;
    transition: all 0.2s ease;
}
.question-item:hover {
    background: #e9ecef;
    border-color: #007bff;
}
.weight-badge {
    background: #17a2b8;
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
}
.btn-action {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
}
</style>

<script>
let questionsData = {{ rules | tojsonfilter | safe }};
let questionModal;

document.addEventListener('DOMContentLoaded', function() {
    questionModal = new bootstrap.Modal(document.getElementById('questionModal'));
    loadSections();
});

function loadSections() {
    const container = document.getElementById('sections-container');
    container.innerHTML = '';
    
    Object.keys(questionsData).forEach(sectionKey => {
        const section = questionsData[sectionKey];
        container.appendChild(createSectionElement(sectionKey, section));
    });
}

function createSectionElement(sectionKey, sectionData) {
    const sectionDiv = document.createElement('div');
    sectionDiv.className = 'section-card';
    
    const questionsHtml = Object.keys(sectionData).map(fieldKey => {
        const question = sectionData[fieldKey];
        const optionsText = question.options ? `Options: ${question.options.join(', ')}` : 'Free text input';
        
        return `
            <div class="question-item">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h6 class="mb-1">${question.question}</h6>
                        <small class="text-muted d-block">Field: ${fieldKey}</small>
                        <small class="text-info">${optionsText}</small>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <span class="weight-badge">Weight: ${question.weight}</span>
                        <button class="btn btn-sm btn-outline-primary btn-action" onclick="editQuestion('${sectionKey}', '${fieldKey}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger btn-action" onclick="deleteQuestion('${sectionKey}', '${fieldKey}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    sectionDiv.innerHTML = `
        <div class="section-header">
            <div>
                <h4 class="mb-0">${sectionKey}</h4>
                <small class="opacity-75">${Object.keys(sectionData).length} questions</small>
            </div>
            <div>
                <button class="btn btn-light btn-sm me-2" onclick="addQuestion('${sectionKey}')">
                    <i class="fas fa-plus"></i> Add Question
                </button>
                <button class="btn btn-outline-light btn-sm" onclick="deleteSection('${sectionKey}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        <div class="p-3">
            ${questionsHtml}
        </div>
    `;
    
    return sectionDiv;
}

function addNewSection() {
    const sectionName = prompt('Enter section name:');
    if (sectionName && !questionsData[sectionName]) {
        questionsData[sectionName] = {};
        loadSections();
    } else if (questionsData[sectionName]) {
        alert('Section already exists!');
    }
}

function deleteSection(sectionKey) {
    if (confirm(`Are you sure you want to delete the "${sectionKey}" section and all its questions?`)) {
        delete questionsData[sectionKey];
        loadSections();
    }
}

function addQuestion(sectionKey) {
    document.getElementById('questionModalTitle').textContent = 'Add Question';
    document.getElementById('questionForm').reset();
    document.getElementById('editingSectionKey').value = sectionKey;
    document.getElementById('editingFieldKey').value = '';
    toggleOptions();
    questionModal.show();
}

function editQuestion(sectionKey, fieldKey) {
    const question = questionsData[sectionKey][fieldKey];
    
    document.getElementById('questionModalTitle').textContent = 'Edit Question';
    document.getElementById('questionText').value = question.question;
    document.getElementById('fieldKey').value = fieldKey;
    document.getElementById('questionWeight').value = question.weight;
    document.getElementById('editingSectionKey').value = sectionKey;
    document.getElementById('editingFieldKey').value = fieldKey;
    
    if (question.options) {
        document.getElementById('questionType').value = 'select';
        document.getElementById('questionOptions').value = question.options.join('\n');
    } else {
        document.getElementById('questionType').value = 'text';
    }
    
    toggleOptions();
    questionModal.show();
}

function deleteQuestion(sectionKey, fieldKey) {
    if (confirm(`Are you sure you want to delete this question?`)) {
        delete questionsData[sectionKey][fieldKey];
        loadSections();
    }
}

function toggleOptions() {
    const questionType = document.getElementById('questionType').value;
    const optionsContainer = document.getElementById('optionsContainer');
    optionsContainer.style.display = questionType === 'select' ? 'block' : 'none';
}

function saveQuestion() {
    const sectionKey = document.getElementById('editingSectionKey').value;
    const oldFieldKey = document.getElementById('editingFieldKey').value;
    const newFieldKey = document.getElementById('fieldKey').value;
    const questionText = document.getElementById('questionText').value;
    const weight = parseInt(document.getElementById('questionWeight').value);
    const questionType = document.getElementById('questionType').value;
    const optionsText = document.getElementById('questionOptions').value;
    
    if (!questionText || !newFieldKey || !weight) {
        alert('Please fill in all required fields');
        return;
    }
    
    // Check if field key already exists (and it's not the same question being edited)
    if (oldFieldKey !== newFieldKey && questionsData[sectionKey][newFieldKey]) {
        alert('A question with this field key already exists in this section!');
        return;
    }
    
    const questionData = {
        question: questionText,
        weight: weight
    };
    
    if (questionType === 'select' && optionsText.trim()) {
        questionData.options = optionsText.split('\n').map(opt => opt.trim()).filter(opt => opt);
    }
    
    // If editing and field key changed, delete old entry
    if (oldFieldKey && oldFieldKey !== newFieldKey) {
        delete questionsData[sectionKey][oldFieldKey];
    }
    
    questionsData[sectionKey][newFieldKey] = questionData;
    
    questionModal.hide();
    loadSections();
}

function saveChanges() {
    fetch('/builder/save', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'rules=' + encodeURIComponent(JSON.stringify(questionsData))
    })
    .then(response => {
        if (response.ok) {
            alert('Changes saved successfully!');
            window.location.reload();
        } else {
            alert('Error saving changes');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving changes');
    });
}
</script>
{% endblock %}
