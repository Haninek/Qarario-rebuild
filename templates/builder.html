
{% extends "layout.html" %}
{% block title %}Risk Assessment Builder{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">ðŸŽ¯ Risk Assessment Builder</h2>
                    <p class="text-muted mb-0">Dynamically manage risk assessment questions and scoring algorithms</p>
                </div>
                <div>
                    <button class="btn btn-info me-2" onclick="testScoring()">
                        <i class="fas fa-calculator"></i> Test Scoring
                    </button>
                    <button class="btn btn-success me-2" onclick="addNewSection()">
                        <i class="fas fa-plus"></i> Add Section
                    </button>
                    <button class="btn btn-primary" onclick="saveChanges()">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </div>

            <!-- Risk Assessment Overview -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h3 id="totalQuestions">{{ rules|length }}</h3>
                            <p class="mb-0">Total Sections</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h3 id="totalWeight">0</h3>
                            <p class="mb-0">Total Weight Points</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <h3 id="avgWeight">0</h3>
                            <p class="mb-0">Avg Weight per Question</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="sections-container">
                <!-- Sections will be dynamically loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Question Modal -->
<div class="modal fade" id="questionModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="questionModalTitle">Add Risk Assessment Question</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="questionForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Question Text</label>
                                <input type="text" class="form-control" id="questionText" required>
                                <div class="form-text">Clear, specific question for risk assessment</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Field Key</label>
                                <input type="text" class="form-control" id="fieldKey" required>
                                <div class="form-text">Unique identifier (e.g., owner1_credit_score)</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Risk Weight (1-20)</label>
                                <input type="number" class="form-control" id="questionWeight" min="1" max="20" required>
                                <div class="form-text">Higher weight = more impact on risk score</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Data Type</label>
                                <select class="form-select" id="questionType" onchange="updateRiskSettings()">
                                    <option value="text">Text Input</option>
                                    <option value="number">Numeric Value</option>
                                    <option value="percentage">Percentage (0-100%)</option>
                                    <option value="currency">Currency Amount</option>
                                    <option value="select">Multiple Choice</option>
                                    <option value="boolean">Yes/No</option>
                                    <option value="date">Date</option>
                                </select>
                            </div>
                            <div class="mb-3" id="riskScoringContainer">
                                <label class="form-label">Risk Scoring Method</label>
                                <select class="form-select" id="riskScoring">
                                    <option value="higher_better">Higher values = Lower risk</option>
                                    <option value="lower_better">Lower values = Lower risk</option>
                                    <option value="range_based">Range-based scoring</option>
                                    <option value="custom">Custom scoring logic</option>
                                </select>
                            </div>
                            <div class="mb-3" id="optionsContainer" style="display: none;">
                                <label class="form-label">Options</label>
                                <div id="optionsList">
                                    <!-- Dynamic options will be added here -->
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addOption()">
                                    <i class="fas fa-plus"></i> Add Option
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row" id="rangeContainer" style="display: none;">
                        <div class="col-12">
                            <h6>Risk Score Ranges</h6>
                            <div class="row">
                                <div class="col-md-3">
                                    <label class="form-label text-success">Excellent (100% score)</label>
                                    <input type="text" class="form-control" id="excellentRange" placeholder="e.g., >= 750">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label text-primary">Good (80% score)</label>
                                    <input type="text" class="form-control" id="goodRange" placeholder="e.g., 650-749">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label text-warning">Fair (60% score)</label>
                                    <input type="text" class="form-control" id="fairRange" placeholder="e.g., 550-649">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label text-danger">Poor (20% score)</label>
                                    <input type="text" class="form-control" id="poorRange" placeholder="e.g., < 550">
                                </div>
                            </div>
                        </div>
                    </div>

                    <input type="hidden" id="editingSectionKey">
                    <input type="hidden" id="editingFieldKey">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveQuestion()">Save Question</button>
            </div>
        </div>
    </div>
</div>

<!-- Test Scoring Modal -->
<div class="modal fade" id="testModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Test Risk Assessment Scoring</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="testForm">
                    <!-- Test form will be generated here -->
                </div>
                <div id="testResults" style="display: none;">
                    <hr>
                    <h6>Risk Assessment Results</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h4 id="testScore" class="text-primary">0</h4>
                                    <p class="mb-0">Risk Score</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h4 id="testTier" class="text-success">Low</h4>
                                    <p class="mb-0">Risk Tier</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h4 id="testPoints">0/0</h4>
                                    <p class="mb-0">Points Earned</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="runTest()">Run Test</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<style>
.section-card {
    border: 2px solid #e9ecef;
    border-radius: 12px;
    margin-bottom: 2rem;
    transition: all 0.3s ease;
}
.section-card:hover {
    border-color: #007bff;
    box-shadow: 0 4px 12px rgba(0,123,255,0.15);
}
.section-header {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 10px 10px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.question-item {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.5rem;
    background: #f8f9fa;
    transition: all 0.2s ease;
}
.question-item:hover {
    background: #e9ecef;
    border-color: #007bff;
}
.weight-badge {
    background: #17a2b8;
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
}
.risk-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
}
.risk-high { background: #dc3545; color: white; }
.risk-medium { background: #ffc107; color: black; }
.risk-low { background: #28a745; color: white; }
.btn-action {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
}
.option-item {
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 0.5rem;
    margin-bottom: 0.5rem;
    background: #f8f9fa;
}
</style>

<script>
let questionsData = {{ rules | tojsonfilter | safe }};
let questionModal, testModal;

document.addEventListener('DOMContentLoaded', function() {
    questionModal = new bootstrap.Modal(document.getElementById('questionModal'));
    testModal = new bootstrap.Modal(document.getElementById('testModal'));
    loadSections();
    updateStats();
});

function updateStats() {
    let totalQuestions = 0;
    let totalWeight = 0;
    
    Object.values(questionsData).forEach(section => {
        Object.values(section).forEach(question => {
            totalQuestions++;
            totalWeight += question.weight || 0;
        });
    });
    
    document.getElementById('totalQuestions').textContent = Object.keys(questionsData).length;
    document.getElementById('totalWeight').textContent = totalWeight;
    document.getElementById('avgWeight').textContent = totalQuestions > 0 ? (totalWeight / totalQuestions).toFixed(1) : 0;
}

function loadSections() {
    const container = document.getElementById('sections-container');
    container.innerHTML = '';
    
    Object.keys(questionsData).forEach(sectionKey => {
        const section = questionsData[sectionKey];
        container.appendChild(createSectionElement(sectionKey, section));
    });
}

function createSectionElement(sectionKey, sectionData) {
    const sectionDiv = document.createElement('div');
    sectionDiv.className = 'section-card';
    
    const sectionWeight = Object.values(sectionData).reduce((sum, q) => sum + (q.weight || 0), 0);
    const riskLevel = sectionWeight > 30 ? 'high' : sectionWeight > 15 ? 'medium' : 'low';
    
    const questionsHtml = Object.keys(sectionData).map(fieldKey => {
        const question = sectionData[fieldKey];
        const optionsText = question.options ? `Options: ${question.options.join(', ')}` : 'Free input';
        const riskWeight = question.weight > 7 ? 'high' : question.weight > 4 ? 'medium' : 'low';
        
        return `
            <div class="question-item">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h6 class="mb-1">${question.question}</h6>
                        <small class="text-muted d-block">Field: ${fieldKey}</small>
                        <small class="text-info">${optionsText}</small>
                        ${question.scoring_method ? `<small class="text-success d-block">Scoring: ${question.scoring_method}</small>` : ''}
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <span class="risk-badge risk-${riskWeight}">Weight: ${question.weight}</span>
                        <button class="btn btn-sm btn-outline-primary btn-action" onclick="editQuestion('${sectionKey}', '${fieldKey}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger btn-action" onclick="deleteQuestion('${sectionKey}', '${fieldKey}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    sectionDiv.innerHTML = `
        <div class="section-header">
            <div>
                <h4 class="mb-0">${sectionKey}</h4>
                <small class="opacity-75">${Object.keys(sectionData).length} questions â€¢ ${sectionWeight} total weight</small>
            </div>
            <div>
                <span class="risk-badge risk-${riskLevel} me-2">${riskLevel.toUpperCase()} IMPACT</span>
                <button class="btn btn-light btn-sm me-2" onclick="addQuestion('${sectionKey}')">
                    <i class="fas fa-plus"></i> Add Question
                </button>
                <button class="btn btn-outline-light btn-sm" onclick="deleteSection('${sectionKey}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        <div class="p-3">
            ${questionsHtml}
        </div>
    `;
    
    return sectionDiv;
}

function addNewSection() {
    const sectionName = prompt('Enter section name for risk assessment:');
    if (sectionName && !questionsData[sectionName]) {
        questionsData[sectionName] = {};
        loadSections();
        updateStats();
    } else if (questionsData[sectionName]) {
        alert('Section already exists!');
    }
}

function deleteSection(sectionKey) {
    if (confirm(`Are you sure you want to delete the "${sectionKey}" section and all its questions?`)) {
        delete questionsData[sectionKey];
        loadSections();
        updateStats();
    }
}

function addQuestion(sectionKey) {
    document.getElementById('questionModalTitle').textContent = 'Add Risk Assessment Question';
    document.getElementById('questionForm').reset();
    document.getElementById('editingSectionKey').value = sectionKey;
    document.getElementById('editingFieldKey').value = '';
    updateRiskSettings();
    questionModal.show();
}

function editQuestion(sectionKey, fieldKey) {
    const question = questionsData[sectionKey][fieldKey];
    
    document.getElementById('questionModalTitle').textContent = 'Edit Risk Assessment Question';
    document.getElementById('questionText').value = question.question;
    document.getElementById('fieldKey').value = fieldKey;
    document.getElementById('questionWeight').value = question.weight;
    document.getElementById('editingSectionKey').value = sectionKey;
    document.getElementById('editingFieldKey').value = fieldKey;
    
    if (question.options) {
        document.getElementById('questionType').value = 'select';
        loadOptionsForEdit(question.options);
    } else {
        document.getElementById('questionType').value = question.data_type || 'text';
    }
    
    updateRiskSettings();
    questionModal.show();
}

function updateRiskSettings() {
    const questionType = document.getElementById('questionType').value;
    const optionsContainer = document.getElementById('optionsContainer');
    const rangeContainer = document.getElementById('rangeContainer');
    const riskScoringContainer = document.getElementById('riskScoringContainer');
    
    optionsContainer.style.display = questionType === 'select' ? 'block' : 'none';
    rangeContainer.style.display = questionType === 'number' || questionType === 'percentage' || questionType === 'currency' ? 'block' : 'none';
    riskScoringContainer.style.display = questionType !== 'select' ? 'block' : 'none';
    
    if (questionType === 'select') {
        document.getElementById('optionsList').innerHTML = '';
        addOption();
    }
}

function addOption() {
    const optionsList = document.getElementById('optionsList');
    const optionDiv = document.createElement('div');
    optionDiv.className = 'option-item';
    optionDiv.innerHTML = `
        <div class="row align-items-center">
            <div class="col-md-6">
                <input type="text" class="form-control form-control-sm" placeholder="Option text" name="optionText">
            </div>
            <div class="col-md-4">
                <input type="number" class="form-control form-control-sm" placeholder="Risk score %" min="0" max="100" name="optionScore">
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.parentElement.parentElement.parentElement.remove()">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
    optionsList.appendChild(optionDiv);
}

function loadOptionsForEdit(options) {
    const optionsList = document.getElementById('optionsList');
    optionsList.innerHTML = '';
    
    options.forEach(option => {
        const optionDiv = document.createElement('div');
        optionDiv.className = 'option-item';
        optionDiv.innerHTML = `
            <div class="row align-items-center">
                <div class="col-md-6">
                    <input type="text" class="form-control form-control-sm" placeholder="Option text" name="optionText" value="${option}">
                </div>
                <div class="col-md-4">
                    <input type="number" class="form-control form-control-sm" placeholder="Risk score %" min="0" max="100" name="optionScore" value="100">
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.parentElement.parentElement.parentElement.remove()">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        optionsList.appendChild(optionDiv);
    });
}

function deleteQuestion(sectionKey, fieldKey) {
    if (confirm(`Are you sure you want to delete this question?`)) {
        delete questionsData[sectionKey][fieldKey];
        loadSections();
        updateStats();
    }
}

function saveQuestion() {
    const sectionKey = document.getElementById('editingSectionKey').value;
    const oldFieldKey = document.getElementById('editingFieldKey').value;
    const newFieldKey = document.getElementById('fieldKey').value;
    const questionText = document.getElementById('questionText').value;
    const weight = parseInt(document.getElementById('questionWeight').value);
    const questionType = document.getElementById('questionType').value;
    
    if (!questionText || !newFieldKey || !weight) {
        alert('Please fill in all required fields');
        return;
    }
    
    if (oldFieldKey !== newFieldKey && questionsData[sectionKey][newFieldKey]) {
        alert('A question with this field key already exists in this section!');
        return;
    }
    
    const questionData = {
        question: questionText,
        weight: weight,
        data_type: questionType
    };
    
    if (questionType === 'select') {
        const options = [];
        const optionTexts = document.querySelectorAll('input[name="optionText"]');
        optionTexts.forEach(input => {
            if (input.value.trim()) {
                options.push(input.value.trim());
            }
        });
        questionData.options = options;
    }
    
    // Add scoring method
    const riskScoring = document.getElementById('riskScoring').value;
    if (riskScoring) {
        questionData.scoring_method = riskScoring;
    }
    
    // If editing and field key changed, delete old entry
    if (oldFieldKey && oldFieldKey !== newFieldKey) {
        delete questionsData[sectionKey][oldFieldKey];
    }
    
    questionsData[sectionKey][newFieldKey] = questionData;
    
    questionModal.hide();
    loadSections();
    updateStats();
}

function testScoring() {
    generateTestForm();
    testModal.show();
}

function generateTestForm() {
    const testForm = document.getElementById('testForm');
    let formHtml = '<div class="row">';
    
    Object.keys(questionsData).forEach(sectionKey => {
        formHtml += `<div class="col-12 mb-3"><h6 class="text-primary">${sectionKey}</h6>`;
        
        Object.keys(questionsData[sectionKey]).forEach(fieldKey => {
            const question = questionsData[sectionKey][fieldKey];
            formHtml += `
                <div class="mb-2">
                    <label class="form-label">${question.question} (Weight: ${question.weight})</label>
            `;
            
            if (question.options) {
                formHtml += `<select class="form-select" name="${fieldKey}">
                    <option value="">Select...</option>`;
                question.options.forEach(option => {
                    formHtml += `<option value="${option}">${option}</option>`;
                });
                formHtml += `</select>`;
            } else {
                formHtml += `<input type="text" class="form-control" name="${fieldKey}" placeholder="Enter value">`;
            }
            
            formHtml += '</div>';
        });
        
        formHtml += '</div>';
    });
    
    formHtml += '</div>';
    testForm.innerHTML = formHtml;
}

function runTest() {
    const testData = {};
    const inputs = document.querySelectorAll('#testForm input, #testForm select');
    
    inputs.forEach(input => {
        if (input.value) {
            testData[input.name] = input.value;
        }
    });
    
    // Call actual scoring API
    fetch('/builder/test', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(testData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.score) {
            document.getElementById('testScore').textContent = data.score.total_score;
            document.getElementById('testTier').textContent = data.tier.replace('_', ' ').toUpperCase();
            document.getElementById('testPoints').textContent = `${data.score.raw_score}/${data.score.max_possible}`;
            
            // Set tier color
            const tierElement = document.getElementById('testTier');
            tierElement.className = 'text-' + (data.score.total_score >= 80 ? 'success' : 
                                              data.score.total_score >= 60 ? 'primary' : 
                                              data.score.total_score >= 50 ? 'warning' : 'danger');
        }
        document.getElementById('testResults').style.display = 'block';
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error testing scoring. Please check your input data.');
    });
}

function saveChanges() {
    fetch('/builder/save', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'rules=' + encodeURIComponent(JSON.stringify(questionsData))
    })
    .then(response => {
        if (response.ok) {
            alert('Risk assessment configuration saved successfully!');
            window.location.reload();
        } else {
            alert('Error saving changes');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving changes');
    });
}
</script>
{% endblock %}
