<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Qarari Risk Score</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      background: #f8f9fa;
      font-family: 'Segoe UI', sans-serif;
    }
    .form-section {
      border-left: 4px solid #0d6efd;
      padding-left: 15px;
      margin-top: 2rem;
      margin-bottom: 1rem;
    }
    .risk-meter {
      font-weight: bold;
      padding: 12px;
      border-radius: 6px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container py-5">
    <h1 class="mb-4 text-primary">Qarari Risk Assessment</h1>
    <form id="scoreForm" class="row g-3" onsubmit="submitScore(event)">
      <div id="formFields"></div>
      <div class="col-12">
        <button type="submit" class="btn btn-primary">Calculate Risk Score</button>
        <a href="/" class="btn btn-outline-secondary ms-2">← Back to Dashboard</a>
      </div>
    </form>
    <div id="results" class="mt-4"></div>
  </div>

  <script>
    let formRules = {};
    let cachedResult = null;

    async function loadFormFields() {
      const response = await fetch('/score/finance-rules');
      formRules = await response.json();
      const container = document.getElementById('formFields');
      let html = '';

      for (const [section, fields] of Object.entries(formRules)) {
        html += `<div class="form-section"><h4>${section}</h4></div>`;

        for (const [fieldKey, fieldData] of Object.entries(fields)) {
          const fieldId = fieldKey;
          const fieldLabel = fieldData.question;

          html += `
            <div class="col-md-6">
              <label for="${fieldId}" class="form-label">${fieldLabel}</label>
              <input type="number" class="form-control" id="${fieldId}" name="${fieldId}" 
                     ${fieldKey.includes('date') ? 'placeholder="YYYY-MM-DD"' : 'step="0.01"'}>
            </div>
          `;
        }
      }

      container.innerHTML = html;
    }

    async function submitScore(event) {
      event.preventDefault();

      const formData = new FormData(event.target);
      const data = {};

      for (let [key, value] of formData.entries()) {
        if (value.trim() !== '') {
          if (key.includes('date')) {
            data[key] = value;
          } else {
            data[key] = parseFloat(value) || 0;
          }
        }
      }

      try {
        const response = await fetch('/score/finance', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });

        const result = await response.json();
        cachedResult = result;
        displayResults(result);
      } catch (error) {
        console.error('Error submitting form:', error);
        document.getElementById('results').innerHTML = 
          '<div class="alert alert-danger">Error calculating score. Please try again.</div>';
      }
    }

    function displayResults(result) {
      const score = result.score.total_score;
      let color = 'danger';
      let riskLevel = 'High Risk';

      if (score >= 80) {
        color = 'success';
        riskLevel = 'Low Risk';
      } else if (score >= 60) {
        color = 'warning';
        riskLevel = 'Moderate Risk';
      }

      const out = document.getElementById('results');
      out.innerHTML = `
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Risk Assessment Results</h5>

            <div class="risk-meter bg-${color} text-white mb-4">
              <h3>Score: ${score.toFixed(1)}/100</h3>
              <p class="mb-0">Risk Level: ${riskLevel}</p>
            </div>

            <div class="mt-4">
              <h5>Recommended Loan Offers:</h5>
              ${result.offers.length > 0 ? `
                <ul class="list-group">
                  ${result.offers.map(amt => `<li class='list-group-item'>$${amt.toLocaleString()}</li>`).join('')}
                </ul>` : `
                <div class="alert alert-warning mt-3">
                  ❌ Your score indicates a high risk of non-payment. At this time, we are unable to extend an offer.
                </div>
              `}
            </div>

            <div class="mt-4">
              <h6>Score Breakdown:</h6>
              <div class="row">
                ${Object.entries(result.score.section_scores).map(([section, score]) => `
                  <div class="col-md-6">
                    <small class="text-muted">${section}</small>
                    <div class="progress mb-2">
                      <div class="progress-bar" style="width: ${score}%">${score.toFixed(1)}%</div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
          <div class="text-end mt-3">
        <button onclick="downloadPDF()" class="btn btn-outline-primary">Download PDF Report</button>
      </div>
        </div>
      `;
    }

    function downloadPDF() {
      if (!cachedResult) {
        alert('Please complete an assessment first before downloading the PDF.');
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 20;

      doc.setFontSize(16);
      doc.text('Qarari Risk Assessment Report', 20, y);
      y += 20;

      doc.setFontSize(12);
      doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, y);
      y += 15;

      const score = cachedResult.score.total_score;
      let riskLevel = 'High Risk';
      if (score >= 80) riskLevel = 'Low Risk';
      else if (score >= 60) riskLevel = 'Moderate Risk';

      doc.setFontSize(14);
      doc.text(`Risk Score: ${score.toFixed(1)}/100`, 20, y);
      y += 10;
      doc.text(`Risk Level: ${riskLevel}`, 20, y);
      y += 20;

      doc.text('Score Breakdown:', 20, y);
      y += 10;

      for (const [section, sectionScore] of Object.entries(cachedResult.score.section_scores)) {
        doc.setFontSize(10);
        doc.text(`${section}: ${sectionScore.toFixed(1)}%`, 25, y);
        y += 8;
      }

      y += 10;
      doc.setFontSize(12);
      doc.text('Loan Offers:', 20, y);
      y += 10;

      if (cachedResult.offers.length > 0) {
        cachedResult.offers.forEach(offer => {
          doc.setFontSize(10);
          doc.text(`$${offer.toLocaleString()}`, 25, y);
          y += 8;
        });
      } else {
        doc.setFontSize(10);
        doc.text('No offers available at this time', 25, y);
      }

      doc.save('qarari-risk-assessment.pdf');
    }

    // Load form fields when page loads
    document.addEventListener('DOMContentLoaded', loadFormFields);
  </script>
</body>
</html>