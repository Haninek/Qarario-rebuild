{% extends "layout.html" %}
{% block title %}Risk Score Form{% endblock %}
{% block content %}
  <h2 class="mb-4">üìã Financial Risk Assessment</h2>
  <form id="scoreForm" class="row g-3" onsubmit="submitScore(event)"></form>
  <div id="scoreOutput" class="mt-5"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    let cachedResult = {};

    const RISK_LABELS = {
      low: '‚úÖ Low Risk',
      moderate: '‚ö†Ô∏è Moderate Risk',
      high: '‚ùó High Risk',
      super_high: '‚ùå Super High Risk'
    };

    const RISK_COLORS = {
      low: 'success',
      moderate: 'warning',
      high: 'danger',
      super_high: 'dark'
    };

    async function loadForm() {
      const res = await fetch('/score/finance-rules');
      const rules = await res.json();
      const form = document.getElementById('scoreForm');
      let step = 1;
      let owner2Confirmed = false;
      let owner1PctPrev = 100; // Start with 100 so first input below 50 triggers popup

      const sectionOrder = [
        "Personal Credit Information",
        "Business Information",
        "Bank Analysis",
        "Background Check",
        "Social Media Presence",
        "Capital & Collateral",
        "Conditions"
      ];

      for (const section of sectionOrder) {
        const fields = rules[section];
        if (!fields) continue;

        form.innerHTML += `<div class="col-12"><h5 class="mt-4">Step ${step++}: ${section}</h5></div>`;

        for (const [key, field] of Object.entries(fields)) {
          const isOwner2 = key.startsWith("owner2_");
          const isOwner1Pct = key === "owner1_ownership_pct";
          const isOptional = key === "underwriter_adjustment";

          const wrapper = document.createElement('div');
          wrapper.className = 'col-md-6';

          const label = document.createElement('label');
          label.className = 'form-label';
          label.innerHTML = `${field.question} <span class="text-muted">(Weight: ${field.weight})</span>`;

          let input;
          if (field.options) {
            input = document.createElement('select');
            input.className = 'form-select';
            if (!isOptional) input.required = true;
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.disabled = true;
            defaultOption.selected = true;
            defaultOption.textContent = '-- Select --';
            input.appendChild(defaultOption);
            field.options.forEach(opt => {
              const o = document.createElement('option');
              o.value = opt;
              o.textContent = opt;
              input.appendChild(o);
            });
          } else {
            input = document.createElement('input');
            if (key.includes('date')) {
              input.type = 'date';
            } else if (key.match(/score|inquiries|amount|value|percent|balance|count|years/i)) {
              input.type = 'number';
              // Use a decimal input mode so that virtual keyboards on mobile
              // devices show a numeric keypad.  For currency‚Äëlike fields we
              // apply tighter validation below.
              input.inputMode = 'decimal';
              input.step = 'any';
              input.min = '0';
              // If the field represents a monetary amount (e.g. contains
              // "amount", "balance", "value", "cash" or "sales"), set a
              // currency pattern to restrict input to numbers with up to two
              // decimal places and provide a more granular step.  This
              // prevents users from entering invalid strings into dollar
              // fields.
              if (key.match(/amount|balance|value|cash|sales/i)) {
                input.step = '0.01';
                input.pattern = '^\\d+(\\.\\d{1,2})?$';
              }
            } else {
              input.type = 'text';
            }
            input.className = 'form-control';
            if (!isOptional) input.required = true;
          }

          input.name = key;
          input.placeholder = field.question;

          // Conditional Owner 2 fields
          if (isOwner2) {
            wrapper.style.display = 'none';
            wrapper.dataset.owner2 = 'true';
          }

            if (isOwner1Pct) {
              /**
               * Owner 1 ownership percentage controls whether the second owner
               * section is visible. We listen for `input` events so the
               * interface reacts immediately as the user types. When the value
               * falls below 50%, the user is asked to confirm adding a second
               * owner. If the percentage later rises back to 50% or more, the
               * confirmation resets and the fields are hidden again.
               */
              const handleOwnershipChange = (e) => {
                console.log('Ownership percentage changed:', e.target.value);
                const val = parseFloat(e.target.value);
                if (isNaN(val)) {
                  console.log('Invalid value, skipping');
                  return;
                }
                const below = val < 50;
                console.log('Below 50%:', below, 'Previous value:', owner1PctPrev, 'Current confirmed:', owner2Confirmed);
                
                // Show popup when ownership drops below 50% for the first time
                if (below && owner1PctPrev >= 50) {
                  owner2Confirmed = confirm("Owner 1 owns less than 50%. Do you want to add details for a second owner?");
                  console.log('User confirmed second owner:', owner2Confirmed);
                } else if (!below && owner1PctPrev < 50) {
                  // Reset confirmation when going back above 50%
                  owner2Confirmed = false;
                  console.log('Reset owner2 confirmation');
                }
                
                owner1PctPrev = val;
                
                // Show/hide owner 2 fields based on percentage and user confirmation
                const owner2Fields = document.querySelectorAll('[data-owner2="true"]');
                console.log('Found owner2 fields:', owner2Fields.length);
                
                if (owner2Fields.length === 0) {
                  console.log('No owner2 fields found - checking all elements with data-owner2');
                  const allOwner2 = document.querySelectorAll('[data-owner2]');
                  console.log('All elements with data-owner2:', allOwner2.length);
                  allOwner2.forEach(el => console.log('Element:', el, 'data-owner2:', el.dataset.owner2));
                }
                
                owner2Fields.forEach(el => {
                  const shouldShow = below && owner2Confirmed;
                  el.style.display = shouldShow ? 'block' : 'none';
                  console.log('Setting field display to:', shouldShow ? 'block' : 'none', 'for element:', el);
                });
              };
              
              input.addEventListener('input', handleOwnershipChange);
              input.addEventListener('change', handleOwnershipChange);
            }

          wrapper.appendChild(label);
          wrapper.appendChild(input);
          form.appendChild(wrapper);
        }
      }

      form.innerHTML += `<div class="col-12 text-end"><button type="submit" class="btn btn-primary">Submit</button></div>`;

      // Set up auto-calculation for years in business after all fields are created
      const startDateInput = document.querySelector('[name="business_start_date"]');
      if (startDateInput) {
        startDateInput.addEventListener('change', e => {
          const startDate = new Date(e.target.value);
          const today = new Date();
          const diff = (today - startDate) / (1000 * 60 * 60 * 24 * 365.25);
          const yearsInput = document.querySelector('[name="years_in_business"]');
          if (yearsInput) {
            yearsInput.value = Math.round(diff);
          }
        });
      }
    }

    async function submitScore(e) {
      e.preventDefault();
      const data = {};
      document.querySelectorAll('#scoreForm [name]').forEach(input => {
        if (input.value && input.value.trim() !== '') {
          data[input.name] = input.value;
        }
      });

      console.log('Submitting data:', data); // Debug log

      try {
        const res = await fetch('/score/finance', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        
        const result = await res.json();
        console.log('Result:', result); // Debug log
      cachedResult = result;

      const score = result.score.total_score;
      const tier = result.tier;
      const risk = RISK_LABELS[tier] || tier;
      const color = RISK_COLORS[tier] || 'secondary';

      const output = document.getElementById('scoreOutput');
      output.textContent = '';

      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${color}`;

      const h4 = document.createElement('h4');
      h4.textContent = `Score: ${score} ‚Äî ${risk}`;
      alertDiv.appendChild(h4);

      const scoreMeta = document.createElement('p');
      scoreMeta.className = 'text-muted';
      scoreMeta.textContent = `Raw: ${result.score.raw_score} / Max: ${result.score.max_possible}`;
      alertDiv.appendChild(scoreMeta);

      output.appendChild(alertDiv);

      if (result.offers.length > 0) {
        const offersHeader = document.createElement('h5');
        offersHeader.textContent = 'Loan Offers:';
        output.appendChild(offersHeader);

        const offerList = document.createElement('ul');
        offerList.className = 'list-group mb-3';
        result.offers.forEach(o => {
          const li = document.createElement('li');
          li.className = 'list-group-item';
          li.textContent = `$${o.toLocaleString()}`;
          offerList.appendChild(li);
        });
        output.appendChild(offerList);

        const pdfBtn = document.createElement('button');
        pdfBtn.addEventListener('click', downloadPDF);
        pdfBtn.className = 'btn btn-outline-primary';
        pdfBtn.textContent = 'Download PDF';
        output.appendChild(pdfBtn);
      } else {
        const noOffer = document.createElement('div');
        noOffer.className = 'alert alert-danger';
        noOffer.textContent = 'No offers ‚Äî super high risk of non-repayment.';
        output.appendChild(noOffer);
      }
      
      } catch (error) {
        console.error('Submission error:', error);
        const output = document.getElementById('scoreOutput');
        output.textContent = '';

        const errDiv = document.createElement('div');
        errDiv.className = 'alert alert-danger';

        const errTitle = document.createElement('h4');
        errTitle.textContent = 'Error';
        errDiv.appendChild(errTitle);

        const errMsg = document.createElement('p');
        errMsg.textContent = `Failed to submit form: ${error.message}`;
        errDiv.appendChild(errMsg);

        output.appendChild(errDiv);
      }
    }

    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 10;
      doc.setFontSize(16);
      doc.text("Qarari Risk Assessment Report", 20, y);
      y += 10;
      doc.setFontSize(12);
      doc.text(`Score: ${cachedResult.score.total_score}`, 20, y);
      doc.text(`Raw: ${cachedResult.score.raw_score}`, 20, y + 7);
      doc.text(`Max: ${cachedResult.score.max_possible}`, 20, y + 14);
      doc.text(`Risk Tier: ${RISK_LABELS[cachedResult.tier] || cachedResult.tier}`, 20, y + 21);
      y += 32;

      doc.setFontSize(10);
      doc.text("Inputs:", 20, y);
      y += 6;
      for (const [k, v] of Object.entries(cachedResult.input || {})) {
        if (y > 270) { doc.addPage(); y = 10; }
        doc.text(`${k}: ${v}`, 20, y);
        y += 5;
      }

      doc.save("qarari-risk-report.pdf");
    }

    window.onload = loadForm;
  </script>
{% endblock %}
