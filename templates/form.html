{% extends "layout.html" %}
{% block title %}Risk Score Form{% endblock %}
{% block content %}
  <h2 class="mb-4">üìã Financial Risk Assessment</h2>
  <form id="scoreForm" class="row g-3"></form>
  <div id="scoreOutput" class="mt-5"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    let cachedResult = {};

    const RISK_LABELS = {
      low: '‚úÖ Low Risk',
      moderate: '‚ö†Ô∏è Moderate Risk',
      high: '‚ùó High Risk',
      super_high: '‚ùå Super High Risk'
    };

    const RISK_COLORS = {
      low: 'success',
      moderate: 'warning',
      high: 'danger',
      super_high: 'dark'
    };

    async function loadForm() {
      const res = await fetch('/score/finance-rules');
      const rules = await res.json();
      const scoreFormElement = document.getElementById('scoreForm');
      let step = 1;
      let owner2Confirmed = false;
      let owner1PctPrev = 100; // Start with 100 so first input below 50 triggers popup

      const sectionOrder = [
        "Personal Credit Information",
        "Business Information",
        "Bank Analysis",
        "Background Check",
        "Social Media Presence",
        "Capital & Collateral",
        "Conditions"
      ];

      for (const section of sectionOrder) {
        const fields = rules[section];
        if (!fields) continue;

        scoreFormElement.innerHTML += `<div class="col-12"><h5 class="mt-4">Step ${step++}: ${section}</h5></div>`;

        for (const [key, field] of Object.entries(fields)) {
          const isOwner2 = key.startsWith("owner2_");
          const isOwner1Pct = key === "owner1_ownership_pct";
          const isOptional = key === "underwriter_adjustment";

          console.log('Creating field:', key, 'isOwner2:', isOwner2);

          const wrapper = document.createElement('div');
          wrapper.className = 'col-md-6';

          const label = document.createElement('label');
          label.className = 'form-label';
          label.innerHTML = `${field.question} <span class="text-muted">(Weight: ${field.weight})</span>`;

          let input;
          if (field.options) {
            input = document.createElement('select');
            input.className = 'form-select';
            if (!isOptional) input.required = true;
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.disabled = true;
            defaultOption.selected = true;
            defaultOption.textContent = '-- Select --';
            input.appendChild(defaultOption);
            field.options.forEach(opt => {
              const o = document.createElement('option');
              o.value = opt;
              o.textContent = opt;
              input.appendChild(o);
            });
          } else {
            input = document.createElement('input');
            if (key.includes('date')) {
              input.type = 'date';
            } else if (key.match(/score|inquiries|amount|value|percent|balance|count|years/i)) {
              input.type = 'number';
              // Use a decimal input mode so that virtual keyboards on mobile
              // devices show a numeric keypad.  For currency‚Äëlike fields we
              // apply tighter validation below.
              input.inputMode = 'decimal';
              input.step = 'any';
              input.min = '0';
              // If the field represents a monetary amount (e.g. contains
              // "amount", "balance", "value", "cash" or "sales"), set a
              // currency pattern to restrict input to numbers with up to two
              // decimal places and provide a more granular step.  This
              // prevents users from entering invalid strings into dollar
              // fields.
              if (key.match(/amount|balance|value|cash|sales/i)) {
                input.step = '0.01';
                input.pattern = '^\\d+(\\.\\d{1,2})?$';
              }
            } else {
              input.type = 'text';
            }
            input.className = 'form-control';
            if (!isOptional) input.required = true;
          }

          input.name = key;
          input.placeholder = field.question;

          // Conditional Owner 2 fields - mark them for later identification
          if (isOwner2) {
            wrapper.style.display = 'none';
            wrapper.setAttribute('data-owner2', 'true');
            wrapper.classList.add('owner2-field');
          }

          // Store reference to ownership percentage input for later event handler setup
          if (isOwner1Pct) {
            input.setAttribute('data-ownership-field', 'true');
          }

          wrapper.appendChild(label);
          wrapper.appendChild(input);
          scoreFormElement.appendChild(wrapper);
        }
      }

      // Create buttons container
      const buttonsDiv = document.createElement('div');
      buttonsDiv.className = 'col-12 d-flex justify-content-between align-items-center mt-4';
      
      // Create autofill button
      const autofillBtn = document.createElement('button');
      autofillBtn.type = 'button';
      autofillBtn.className = 'btn btn-outline-secondary';
      autofillBtn.innerHTML = '<i class="fas fa-magic"></i> Autofill Sample Data';
      autofillBtn.addEventListener('click', autofillForm);
      
      // Create submit button
      const submitBtn = document.createElement('button');
      submitBtn.type = 'submit';
      submitBtn.className = 'btn btn-primary';
      submitBtn.textContent = 'Submit Assessment';
      
      buttonsDiv.appendChild(autofillBtn);
      buttonsDiv.appendChild(submitBtn);
      scoreFormElement.appendChild(buttonsDiv);
      
      console.log('Submit button created and added to form');

      // Debug: Check if owner2 fields were created properly
      console.log('Form creation complete. Checking for owner2 fields...');
      const allOwner2Elements = document.querySelectorAll('.owner2-field');
      console.log('Total elements with class owner2-field:', allOwner2Elements.length);
      allOwner2Elements.forEach((el, index) => {
        console.log(`Owner2 element ${index}:`, el, 'display:', el.style.display);
      });

      // Set up ownership percentage event handler AFTER all fields are created
      const ownershipInput = document.querySelector('[data-ownership-field="true"]');
      if (ownershipInput) {
        console.log('Setting up ownership percentage event handler...');

        const handleOwnershipChange = (e) => {
          const val = parseFloat(e.target.value) || 0;
          const below = val < 50;

          console.log('Ownership changed:', val, 'Below 50:', below, 'Confirmed:', owner2Confirmed, 'Previous:', owner1PctPrev);

          // Show popup when ownership drops below 50% for the first time
          if (below && owner1PctPrev >= 50) {
            owner2Confirmed = confirm("Owner 1 owns less than 50%. Do you want to add details for a second owner?");
            console.log('User confirmed adding second owner:', owner2Confirmed);
          } else if (!below && owner1PctPrev < 50) {
            // Reset confirmation when going back above 50%
            owner2Confirmed = false;
            console.log('Reset owner2 confirmation - back above 50%');
          }

          owner1PctPrev = val;

          // Show/hide owner 2 fields - use both class and attribute selectors
          const owner2Fields = document.querySelectorAll('.owner2-field, [data-owner2="true"]');
          console.log('Found owner2 fields using combined selector:', owner2Fields.length);

          owner2Fields.forEach((el, index) => {
            const shouldShow = below && owner2Confirmed;
            console.log(`Field ${index}:`, el.querySelector('label')?.textContent || 'Unknown', 'shouldShow:', shouldShow);
            el.style.display = shouldShow ? 'block' : 'none';
          });
        };

        ownershipInput.addEventListener('input', handleOwnershipChange);
        ownershipInput.addEventListener('change', handleOwnershipChange);

        // Test owner2 field detection after event handler setup
        console.log('Testing owner2 field detection after event handler setup...');
        const testFields = document.querySelectorAll('.owner2-field, [data-owner2="true"]');
        console.log('Test found', testFields.length, 'owner2 fields');
        testFields.forEach((el, index) => {
          console.log(`Test field ${index}:`, el.querySelector('label')?.textContent || 'Unknown');
        });
      }

      // Add form submit event listener immediately
      scoreFormElement.addEventListener('submit', function(e) {
        console.log('Form submit event fired');
        submitScore(e);
      });
      console.log('Form submit event listener added');

      // Set up auto-calculation for years in business after all fields are created
      const startDateInput = document.querySelector('[name="business_start_date"]');
      if (startDateInput) {
        startDateInput.addEventListener('change', e => {
          const startDate = new Date(e.target.value);
          const today = new Date();
          const diff = (today - startDate) / (1000 * 60 * 60 * 24 * 365.25);
          const yearsInput = document.querySelector('[name="years_in_business"]');
          if (yearsInput) {
            yearsInput.value = Math.round(diff);
          }
        });
      }
    }

    async function submitScore(e) {
      console.log('submitScore function called!');
      e.preventDefault();
      console.log('Form submission started...');

      const data = {};
      const allInputs = document.querySelectorAll('#scoreForm [name]');
      console.log('Found inputs:', allInputs.length);

      allInputs.forEach(input => {
        console.log(`Input ${input.name}: value="${input.value}", required=${input.required}`);
        if (input.value && input.value.trim() !== '') {
          data[input.name] = input.value;
        }
      });

      console.log('Submitting data:', data); // Debug log

      // Check for required fields
      const requiredInputs = document.querySelectorAll('#scoreForm [required]');
      const missingRequired = [];
      requiredInputs.forEach(input => {
        if (!input.value || input.value.trim() === '') {
          missingRequired.push(input.name);
        }
      });

      if (missingRequired.length > 0) {
        console.log('Missing required fields:', missingRequired);
        alert('Please fill in all required fields: ' + missingRequired.join(', '));
        return false; // Ensure false is returned on validation failure
      }

      try {
        const res = await fetch('/score/finance', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }

        const result = await res.json();
        console.log('Result:', result); // Debug log
      cachedResult = result;

      const score = result.score.total_score;
      const tier = result.tier;
      const risk = RISK_LABELS[tier] || tier;
      const color = RISK_COLORS[tier] || 'secondary';

      const output = document.getElementById('scoreOutput');
      output.textContent = '';

      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${color}`;

      const h4 = document.createElement('h4');
      h4.textContent = `Score: ${score} ‚Äî ${risk}`;
      alertDiv.appendChild(h4);

      const scoreMeta = document.createElement('p');
      scoreMeta.className = 'text-muted';
      scoreMeta.textContent = `Raw: ${result.score.raw_score} / Max: ${result.score.max_possible}`;
      alertDiv.appendChild(scoreMeta);

      output.appendChild(alertDiv);

      if (result.offers.length > 0) {
        const offersHeader = document.createElement('h5');
        offersHeader.textContent = 'Loan Offers:';
        output.appendChild(offersHeader);

        const offerList = document.createElement('ul');
        offerList.className = 'list-group mb-3';
        result.offers.forEach(o => {
          const li = document.createElement('li');
          li.className = 'list-group-item';
          li.textContent = `$${o.toLocaleString()}`;
          offerList.appendChild(li);
        });
        output.appendChild(offerList);

        const pdfBtn = document.createElement('button');
        pdfBtn.addEventListener('click', downloadPDF);
        pdfBtn.className = 'btn btn-outline-primary';
        pdfBtn.textContent = 'Download PDF';
        output.appendChild(pdfBtn);
      } else {
        const noOffer = document.createElement('div');
        noOffer.className = 'alert alert-danger';
        noOffer.textContent = 'No offers ‚Äî super high risk of non-repayment.';
        output.appendChild(noOffer);
      }

      } catch (error) {
        console.error('Submission error:', error);
        const output = document.getElementById('scoreOutput');
        output.textContent = '';

        const errDiv = document.createElement('div');
        errDiv.className = 'alert alert-danger';

        const errTitle = document.createElement('h4');
        errTitle.textContent = 'Error';
        errDiv.appendChild(errTitle);

        const errMsg = document.createElement('p');
        errMsg.textContent = `Failed to submit form: ${error.message}`;
        errDiv.appendChild(errMsg);

        output.appendChild(errDiv);
      }
      return true; // Ensure true is returned on successful submission
    }

    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 10;
      doc.setFontSize(16);
      doc.text("Qarari Risk Assessment Report", 20, y);
      y += 10;
      doc.setFontSize(12);
      doc.text(`Score: ${cachedResult.score.total_score}`, 20, y);
      doc.text(`Raw: ${cachedResult.score.raw_score}`, 20, y + 7);
      doc.text(`Max: ${cachedResult.score.max_possible}`, 20, y + 14);
      doc.text(`Risk Tier: ${RISK_LABELS[cachedResult.tier] || cachedResult.tier}`, 20, y + 21);
      y += 32;

      doc.setFontSize(10);
      doc.text("Inputs:", 20, y);
      y += 6;
      for (const [k, v] of Object.entries(cachedResult.input || {})) {
        if (y > 270) { doc.addPage(); y = 10; }
        doc.text(`${k}: ${v}`, 20, y);
        y += 5;
      }

      doc.save("qarari-risk-report.pdf");
    }

    function autofillForm() {
      console.log('Autofilling form with sample data...');
      
      const sampleData = {
        // Personal Credit Information
        'owner1_credit_score': '720',
        'owner1_ownership_pct': '75',
        'owner1_inquiries': '2',
        'owner1_utilization': '25',
        'owner1_past_due': '0',
        
        // Business Information
        'business_start_date': '2020-01-15',
        'intelliscore': '85',
        'stability_score': '78',
        'business_inquiries': '1',
        'years_in_business': '4',
        
        // Bank Analysis
        'daily_average_balance': '25000',
        'monthly_deposits': '45000',
        'nsf_count': '0',
        'negative_days': '2',
        'deposit_frequency': '15',
        
        // Background Check
        'criminal_background': 'Yes',
        'judgment_liens': 'Yes',
        'ucc_filings': 'Yes',
        'contact_verification': 'Yes',
        
        // Social Media Presence
        'company_website': 'Yes',
        'facebook_presence': 'Yes',
        'linkedin_presence': 'Yes',
        'review_sites': 'Yes',
        
        // Capital & Collateral
        'business_location_date': '2020-01-15',
        'location_quality': 'Good',
        'distance_from_residence': '5',
        'business_assets': 'Equipment/Machinery',
        'asset_value': '150000',
        
        // Conditions
        'industry_type': 'Professional Services',
        'loan_purpose': 'Working Capital',
        'requested_amount': '100000'
      };
      
      // Fill in the form fields
      for (const [fieldName, value] of Object.entries(sampleData)) {
        const field = document.querySelector(`[name="${fieldName}"]`);
        if (field) {
          field.value = value;
          console.log(`Filled ${fieldName} with ${value}`);
        }
      }
      
      console.log('Autofill complete!');
    }

    window.onload = loadForm;
  </script>
{% endblock %}